"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_lambda_1 = require("@aws-cdk/aws-lambda");
const core_1 = require("@aws-cdk/core");
const aws_cloudformation_1 = require("@aws-cdk/aws-cloudformation");
const aws_s3_1 = require("@aws-cdk/aws-s3");
const path = require("path");
class AutoDeleteBucket extends aws_s3_1.Bucket {
    constructor(scope, id, props = {}) {
        super(scope, id, {
            ...props,
            removalPolicy: core_1.RemovalPolicy.DESTROY
        });
        const lambda = new aws_lambda_1.SingletonFunction(this, 'AutoBucketHandler', {
            uuid: '7677dc81-117d-41c0-b75b-db11cb84bb70',
            runtime: aws_lambda_1.Runtime.NODEJS_10_X,
            code: aws_lambda_1.Code.asset(path.join(__dirname, '../lambda')),
            handler: 'main.handler',
            lambdaPurpose: 'AutoBucket',
            timeout: core_1.Duration.minutes(15)
        });
        const provider = aws_cloudformation_1.CustomResourceProvider.lambda(lambda);
        // allow the bucket contents to be read and deleted by the lambda
        this.grantReadWrite(lambda);
        new aws_cloudformation_1.CustomResource(this, 'AutoBucket', {
            provider,
            resourceType: 'Custom::AutoDeleteBucket',
            properties: {
                bucketName: this.bucketName
            }
        });
    }
}
exports.AutoDeleteBucket = AutoDeleteBucket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0by1kZWxldGUtYnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3Jlc291cmNlL2F1dG8tZGVsZXRlLWJ1Y2tldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUFzRTtBQUN0RSx3Q0FBa0U7QUFDbEUsb0VBR29DO0FBQ3BDLDRDQUFxRDtBQUNyRCw2QkFBNkI7QUFFN0IsTUFBYSxnQkFBaUIsU0FBUSxlQUFNO0lBQzFDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBcUIsRUFBRTtRQUMvRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRTtZQUNmLEdBQUcsS0FBSztZQUNSLGFBQWEsRUFBRSxvQkFBYSxDQUFDLE9BQU87U0FDckMsQ0FBQyxDQUFBO1FBRUYsTUFBTSxNQUFNLEdBQUcsSUFBSSw4QkFBaUIsQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLEVBQUU7WUFDOUQsSUFBSSxFQUFFLHNDQUFzQztZQUM1QyxPQUFPLEVBQUUsb0JBQU8sQ0FBQyxXQUFXO1lBQzVCLElBQUksRUFBRSxpQkFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUNuRCxPQUFPLEVBQUUsY0FBYztZQUN2QixhQUFhLEVBQUUsWUFBWTtZQUMzQixPQUFPLEVBQUUsZUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7U0FDOUIsQ0FBQyxDQUFBO1FBRUYsTUFBTSxRQUFRLEdBQUcsMkNBQXNCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRXRELGlFQUFpRTtRQUNqRSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRTNCLElBQUksbUNBQWMsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFO1lBQ3JDLFFBQVE7WUFDUixZQUFZLEVBQUUsMEJBQTBCO1lBQ3hDLFVBQVUsRUFBRTtnQkFDVixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7YUFDNUI7U0FDRixDQUFDLENBQUE7SUFDSixDQUFDO0NBQ0Y7QUE3QkQsNENBNkJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29kZSwgUnVudGltZSwgU2luZ2xldG9uRnVuY3Rpb24gfSBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhJ1xuaW1wb3J0IHsgQ29uc3RydWN0LCBSZW1vdmFsUG9saWN5LCBEdXJhdGlvbiB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnXG5pbXBvcnQge1xuICBDdXN0b21SZXNvdXJjZSxcbiAgQ3VzdG9tUmVzb3VyY2VQcm92aWRlclxufSBmcm9tICdAYXdzLWNkay9hd3MtY2xvdWRmb3JtYXRpb24nXG5pbXBvcnQgeyBCdWNrZXQsIEJ1Y2tldFByb3BzIH0gZnJvbSAnQGF3cy1jZGsvYXdzLXMzJ1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcblxuZXhwb3J0IGNsYXNzIEF1dG9EZWxldGVCdWNrZXQgZXh0ZW5kcyBCdWNrZXQge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQnVja2V0UHJvcHMgPSB7fSkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwge1xuICAgICAgLi4ucHJvcHMsXG4gICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1lcbiAgICB9KVxuXG4gICAgY29uc3QgbGFtYmRhID0gbmV3IFNpbmdsZXRvbkZ1bmN0aW9uKHRoaXMsICdBdXRvQnVja2V0SGFuZGxlcicsIHtcbiAgICAgIHV1aWQ6ICc3Njc3ZGM4MS0xMTdkLTQxYzAtYjc1Yi1kYjExY2I4NGJiNzAnLFxuICAgICAgcnVudGltZTogUnVudGltZS5OT0RFSlNfMTBfWCxcbiAgICAgIGNvZGU6IENvZGUuYXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2xhbWJkYScpKSxcbiAgICAgIGhhbmRsZXI6ICdtYWluLmhhbmRsZXInLFxuICAgICAgbGFtYmRhUHVycG9zZTogJ0F1dG9CdWNrZXQnLFxuICAgICAgdGltZW91dDogRHVyYXRpb24ubWludXRlcygxNSlcbiAgICB9KVxuXG4gICAgY29uc3QgcHJvdmlkZXIgPSBDdXN0b21SZXNvdXJjZVByb3ZpZGVyLmxhbWJkYShsYW1iZGEpXG5cbiAgICAvLyBhbGxvdyB0aGUgYnVja2V0IGNvbnRlbnRzIHRvIGJlIHJlYWQgYW5kIGRlbGV0ZWQgYnkgdGhlIGxhbWJkYVxuICAgIHRoaXMuZ3JhbnRSZWFkV3JpdGUobGFtYmRhKVxuXG4gICAgbmV3IEN1c3RvbVJlc291cmNlKHRoaXMsICdBdXRvQnVja2V0Jywge1xuICAgICAgcHJvdmlkZXIsXG4gICAgICByZXNvdXJjZVR5cGU6ICdDdXN0b206OkF1dG9EZWxldGVCdWNrZXQnLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBidWNrZXROYW1lOiB0aGlzLmJ1Y2tldE5hbWVcbiAgICAgIH1cbiAgICB9KVxuICB9XG59XG4iXX0=